#!/usr/bin/env bash
source /etc/default/bazzite

# Opt out of and remove Fedora's flatpak repo
if grep -qz 'fedora' <<< $(flatpak remotes); then
  /usr/lib/fedora-third-party/fedora-third-party-opt-out
  /usr/bin/fedora-third-party disable
  flatpak remote-delete fedora --force
fi

# Lists of flatpaks
FLATPAK_LIST=$(flatpak list --column=application)
INSTALL_LIST=$(cat /usr/etc/flatpak/install)
REMOVE_LIST=$(cat /usr/etc/flatpak/remove)

# Add Deck flatpaks to install list
if [[ $IMAGE_NAME =~ "deck" ]]; then
  DECK_LIST=$(cat /usr/etc/flatpak/deck)
  if [[ -n $DECK_LIST ]]; then
    INSTALL_LIST="$INSTALL_LIST\n$DECK_LIST"
  fi
fi

# Install flatpaks in list
if [[ -n $INSTALL_LIST ]]; then
  for flatpak in $INSTALL_LIST; do
    if grep -qvz $flatpak <<< $FLATPAK_LIST; then
      flatpak install --system --noninteractive flathub $flatpak
    fi
  done
fi

# Remove flatpaks in list
if [[ -n $REMOVE_LIST ]]; then
  for flatpak in $REMOVE_LIST; do
    if grep -qz $flatpak <<< $FLATPAK_LIST; then
      flatpak remove --system --noninteractive $flatpak
    fi
  done
fi
